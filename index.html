<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>商品管理後台</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
#imageDrop {
  border: 2px dashed #0d6efd;
  border-radius: 5px;
  padding: 30px;
  text-align: center;
  font-weight: bold;
  color: #0d6efd;
  transition: 0.3s;
  cursor: pointer;
}
#imageDrop.dragover { background:#e9f7ff; border-color:#0b5ed7; }
#preview img { max-width:100px; max-height:80px; margin:5px; border-radius:5px; cursor:pointer; }
</style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4">商品管理後台</h2>

  <!-- 新增 / 修改商品 -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">新增 / 修改商品</h5>
      <input type="hidden" id="rowId">

      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">商品名稱</label><input type="text" id="商品名稱" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">價格</label><input type="number" id="價格" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">庫存</label><input type="number" id="庫存" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">分類</label><input type="text" id="分類" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">是否上架</label>
          <select id="是否上架" class="form-select">
            <option value="是">是</option>
            <option value="否">否</option>
          </select>
        </div>
        <div class="col-12"><label class="form-label">商品簡介</label><textarea id="商品簡介" class="form-control"></textarea></div>
        <div class="col-12"><label class="form-label">規格</label><textarea id="規格" class="form-control"></textarea></div>

        <!-- 拖曳圖片 -->
        <div class="col-12">
          <label class="form-label">上傳商品圖片（拖曳或點擊選擇）</label>
          <div id="imageDrop">拖曳圖片到此或點擊選擇</div>
          <input type="file" id="imageFile" multiple style="display:none;">
          <div id="preview" class="mt-2"></div>
        </div>

        <div class="col-12">
          <button class="btn btn-primary" onclick="saveProduct()">儲存商品</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 商品列表 -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">商品列表</h5>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="productTable">
          <thead class="table-dark">
            <tr>
              <th>#</th><th>名稱</th><th>價格</th><th>庫存</th><th>分類</th>
              <th>簡介</th><th>規格</th><th>上架</th><th>圖片</th><th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyD3DolaYqCIbbeKDrXn8K_ADdZ_lSyWVKALno2w9SzKM67E51KXqqgefL5lqa1P9FGEw/exec";

let products = [];
let imagesToUpload = [];

// -------------------- 拖曳 & 選擇圖片 --------------------
const imageDrop = document.getElementById('imageDrop');
const imageFileInput = document.getElementById('imageFile');
const previewDiv = document.getElementById('preview');

imageDrop.addEventListener('click', ()=> imageFileInput.click());
imageDrop.addEventListener('dragover', e=> { e.preventDefault(); imageDrop.classList.add('dragover'); });
imageDrop.addEventListener('dragleave', e=> { e.preventDefault(); imageDrop.classList.remove('dragover'); });
imageDrop.addEventListener('drop', e=>{
  e.preventDefault();
  imageDrop.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
imageFileInput.addEventListener('change', e=> handleFiles(e.target.files));

function handleFiles(files){
  for(const file of files){
    if(!file.type.startsWith('image/')) continue;
    imagesToUpload.push(file);
    const reader = new FileReader();
    reader.onload = e=>{
      const img = document.createElement('img');
      img.src = e.target.result;
      img.onclick = ()=> { 
        const idx = imagesToUpload.indexOf(file);
        if(idx>-1) imagesToUpload.splice(idx,1);
        img.remove();
      }
      previewDiv.appendChild(img);
    }
    reader.readAsDataURL(file);
  }
}

// -------------------- 壓縮圖片 --------------------
function compressImage(file, maxSize=300*1024){
  return new Promise(resolve=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = e=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const scale = Math.sqrt(maxSize / file.size);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>{
          resolve(blob);
        }, file.type, 0.8);
      }
    }
  });
}

// -------------------- 上傳圖片 --------------------
async function uploadImages(){
  let uploadedIds = [];
  for(const file of imagesToUpload){
    const blob = await compressImage(file);
    const formData = new FormData();
    formData.append('file', blob, file.name);
    formData.append('action', 'uploadImage');
    const res = await fetch(GAS_URL, { method:'POST', body: formData });
    const data = await res.json();
    if(data.status==='success') uploadedIds.push(data.fileId);
  }
  imagesToUpload = [];
  previewDiv.innerHTML = '';
  return uploadedIds;
}

// -------------------- 儲存商品 --------------------
async function saveProduct(){
  const fileIds = await uploadImages();
  const payload = {
    action:'save',
    rowId: document.getElementById('rowId').value,
    '商品名稱': document.getElementById('商品名稱').value,
    '價格': document.getElementById('價格').value,
    '庫存': document.getElementById('庫存').value,
    '分類': document.getElementById('分類').value,
    '商品簡介': document.getElementById('商品簡介').value,
    '規格': document.getElementById('規格').value,
    '是否上架': document.getElementById('是否上架').value,
    '圖片檔名': fileIds.join(',')
  };
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.status==='success'){
    alert('儲存成功');
    clearForm();
    loadProducts();
  } else alert('儲存失敗:'+data.message);
}

// -------------------- 讀取商品 --------------------
async function loadProducts(){
  const res = await fetch(GAS_URL+'?action=getProducts');
  products = await res.json();
  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = '';
  products.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${p['商品名稱']||''}</td>
      <td>${p['價格']||''}</td>
      <td>${p['庫存']||''}</td>
      <td>${p['分類']||''}</td>
      <td>${p['商品簡介']||''}</td>
      <td>${p['規格']||''}</td>
      <td>${p['是否上架']||''}</td>
      <td>${p['圖片連結']?`<img src="${p['圖片連結']}">`:''}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editProduct('${p.rowId}')">編輯</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.rowId}')">刪除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// -------------------- 編輯 / 刪除 --------------------
function editProduct(rowId){
  const p = products.find(p=>p.rowId===rowId);
  if(!p) return;
  document.getElementById('rowId').value = rowId;
  document.getElementById('商品名稱').value = p['商品名稱'];
  document.getElementById('價格').value = p['價格'];
  document.getElementById('庫存').value = p['庫存'];
  document.getElementById('分類').value = p['分類'];
  document.getElementById('商品簡介').value = p['商品簡介'];
  document.getElementById('規格').value = p['規格'];
  document.getElementById('是否上架').value = p['是否上架'];
}

async function deleteProduct(rowId){
  if(!confirm('確定刪除？')) return;
  const res = await fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'delete', rowId})
  });
  const data = await res.json();
  if(data.status==='success') loadProducts();
}

// -------------------- 清空表單 --------------------
function clearForm(){
  document.getElementById('rowId').value='';
  ['商品名稱','價格','庫存','分類','商品簡介','規格','是否上架'].forEach(id=>document.getElementById(id).value='');
}
window.onload = loadProducts;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>




