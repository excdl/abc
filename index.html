<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>商品管理後台</title>

<style>
body{
  font-family: 'Segoe UI', '微軟正黑體', sans-serif;
  background:#f2f4f7;
  margin:0;
  padding:0;
}

header{
  background:#3b82f6;
  color:white;
  padding:15px 25px;
  font-size:22px;
  font-weight:bold;
}

.container{
  padding:20px;
  max-width:1100px;
  margin:auto;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
}
.btn-primary{ background:#3b82f6; color:white; }
.btn-danger{ background:#ef4444; color:white; }
.btn-light{ background:#e5e7eb; }

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:white;
  border-radius:8px;
  overflow:hidden;
}
th{
  background:#e5e7eb;
  padding:10px;
  font-weight:bold;
}
td{
  border-top:1px solid #ddd;
  padding:10px;
}
img{
  width:80px;
  height:80px;
  object-fit:cover;
  border-radius:6px;
}

/* --- Modal 視窗 --- */
.modal-bg{
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
}
.modal{
  background:white;
  padding:20px;
  width:420px;
  border-radius:8px;
  box-shadow:0 5px 20px rgba(0,0,0,0.2);
}
.modal h3{ margin-top:0; }

/* 拖曳區 */
#dropArea{
  border:2px dashed #3b82f6;
  padding:20px;
  text-align:center;
  border-radius:8px;
  margin-top:10px;
  cursor:pointer;
  background:#f8fafc;
}
#dropArea.hover{
  background:#dbeafe;
}
#preview{
  margin-top:10px;
  text-align:center;
}
#preview img{
  width:120px;
  height:120px;
  border-radius:10px;
  object-fit:cover;
}
</style>
</head>

<body>
<header>商品管理後台</header>
<div class="container">

<button class="btn-primary" onclick="openModal()">＋ 新增商品</button>

<table id="productTable">
  <thead>
    <tr>
      <th>#</th><th>名稱</th><th>價格</th><th>庫存</th>
      <th>分類</th><th>圖片</th><th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>

<!-- Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">新增商品</h3>

    <input type="hidden" id="rowId">

    <label>商品名稱</label>
    <input id="商品名稱" style="width:100%;margin-bottom:6px;" />

    <label>價格</label>
    <input id="價格" type="number" style="width:100%;margin-bottom:6px;" />

    <label>庫存</label>
    <input id="庫存" type="number" style="width:100%;margin-bottom:6px;" />

    <label>分類</label>
    <input id="分類" style="width:100%;margin-bottom:6px;" />

    <label>商品簡介</label>
    <textarea id="商品簡介" style="width:100%;height:60px;margin-bottom:6px;"></textarea>

    <label>規格</label>
    <textarea id="規格" style="width:100%;height:60px;margin-bottom:6px;"></textarea>

    <label>狀態</label>
    <select id="是否上架" style="width:100%;margin-bottom:6px;">
      <option value="是">是</option>
      <option value="否">否</option>
    </select>

    <!-- 拖曳上傳區 -->
    <label>商品圖片</label>
    <div id="dropArea">拖曳圖片到此處或點擊上傳</div>
    <input type="file" id="imageInput" style="display:none;">
    <div id="preview"></div>

    <input type="hidden" id="圖片檔名">

    <br>
    <button class="btn-primary" onclick="saveProduct()">儲存</button>
    <button class="btn-light" onclick="closeModal()">取消</button>
  </div>
</div>

<script>
// --- 改這裡換成你的 GAS URL ---
const GAS_URL = "https://script.google.com/macros/s/AKfycby9KW7BpI0TFRxW7scn2aTl_ZaZmf_QZWHGjPpAVRuYVy1OKH-IsiaaEecAKwyPQ0YnIA/exec";

// 開關 Modal
function openModal(p=null){
  document.getElementById("modalBg").style.display="flex";

  if(p){
    document.getElementById("modalTitle").innerText="編輯商品";
    document.getElementById("rowId").value = p.rowId;
    document.getElementById("商品名稱").value = p["商品名稱"];
    document.getElementById("價格").value = p["價格"];
    document.getElementById("庫存").value = p["庫存"];
    document.getElementById("分類").value = p["分類"];
    document.getElementById("商品簡介").value = p["商品簡介"];
    document.getElementById("規格").value = p["規格"];
    document.getElementById("是否上架").value = p["是否上架"];
    document.getElementById("圖片檔名").value = p["圖片檔名"] || "";
    if(p["圖片連結"]) {
      document.getElementById("preview").innerHTML = `<img src="${p["圖片連結"]}">`;
    }
  }else{
    document.getElementById("modalTitle").innerText="新增商品";
    document.querySelectorAll(".modal input, .modal textarea").forEach(e=>e.value="");
    document.getElementById("preview").innerHTML="";
  }
}

function closeModal(){
  document.getElementById("modalBg").style.display="none";
}

// 取得商品列表
function loadProducts(){
  fetch(GAS_URL+"?action=getProducts")
    .then(r=>r.json())
    .then(res=>{
      const tbody = document.querySelector("#productTable tbody");
      tbody.innerHTML="";

      res.forEach((p,i)=>{
        tbody.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td>${p["商品名稱"]||''}</td>
            <td>${p["價格"]||''}</td>
            <td>${p["庫存"]||''}</td>
            <td>${p["分類"]||''}</td>
            <td>${p["圖片連結"] ? `<img src="${p["圖片連結"]}">` : ''}</td>
            <td>
              <button class="btn-primary" onclick='openModal(${JSON.stringify(p)})'>編輯</button>
              <button class="btn-danger" onclick='deleteProduct("${p.rowId}")'>刪除</button>
            </td>
          </tr>
        `;
      });
    });
}

// 儲存商品
function saveProduct(){
  const data = {
    action:"save",
    rowId:document.getElementById("rowId").value,
    "商品名稱":document.getElementById("商品名稱").value,
    "價格":document.getElementById("價格").value,
    "庫存":document.getElementById("庫存").value,
    "分類":document.getElementById("分類").value,
    "商品簡介":document.getElementById("商品簡介").value,
    "規格":document.getElementById("規格").value,
    "是否上架":document.getElementById("是否上架").value,
    "圖片檔名":document.getElementById("圖片檔名").value
  };

  fetch(GAS_URL, { method:"POST", body:JSON.stringify(data) })
    .then(r=>r.json())
    .then(res=>{
      closeModal();
      loadProducts();
    });
}

// 刪除商品
function deleteProduct(id){
  if(!confirm("確定刪除？")) return;

  fetch(GAS_URL, {
    method:"POST",
    body:JSON.stringify({action:"delete", rowId:id})
  })
  .then(r=>r.json())
  .then(()=>loadProducts());
}

// --- 圖片拖曳上傳 ---
const dropArea = document.getElementById("dropArea");
const imageInput = document.getElementById("imageInput");

// 點擊觸發 input
dropArea.onclick = ()=> imageInput.click();

// 拖曳效果
dropArea.addEventListener("dragover", e=>{
  e.preventDefault();
  dropArea.classList.add("hover");
});
dropArea.addEventListener("dragleave", ()=> dropArea.classList.remove("hover"));
dropArea.addEventListener("drop", e=>{
  e.preventDefault();
  dropArea.classList.remove("hover");
  uploadImage(e.dataTransfer.files[0]);
});

imageInput.onchange = e => uploadImage(e.target.files[0]);

function uploadImage(file){
  if(!file) return;

  const form = new FormData();
  form.append("action","uploadImage");
  form.append("file", file);

  fetch(GAS_URL, {method:"POST", body:form})
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="success"){
      document.getElementById("圖片檔名").value = res.fileId;
      document.getElementById("preview").innerHTML = `<img src="${res.url}">`;
    }else{
      alert("圖片上傳失敗：" + res.message);
    }
  });
}

loadProducts();
</script>

</body>
</html>

